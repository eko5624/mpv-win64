pkgname=libjxl-dev
pkgver=0.6.1
pkgrel=1
pkgdesc='JPEG XL image format reference implementation'
arch=('x86_64')
url="https://github.com/libjxl/libjxl/"
license=('BSD')
conflicts=("mingw-w64-x86_64-highway" "mingw-w64-x86_64-zlib" "mingw-w64-x86_64-brotli")
source=("git+https://github.com/libjxl/libjxl"
        "git+https://github.com/google/brotli"
        "git+https://github.com/gflags/gflags"
        "git+https://github.com/google/googletest"
        "git+https://github.com/google/highway"
        "git+https://github.com/mm2/Little-CMS"
        "git+https://github.com/glennrp/libpng.git"
        "git+https://github.com/webmproject/sjpeg.git"
        "git+https://skia.googlesource.com/skcms"
        "git+https://github.com/libjxl/testdata"
        "git+https://github.com/madler/zlib.git")
md5sums=('SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP' 'SKIP')

prepare() {
  cd $srcdir/libjxl
  mv ${srcdir}/Little-CMS ${srcdir}/lcms
  git submodule init
  git config --local submodule.third_party/brotli.url "${srcdir}/brotli"
  git config --local submodule.third_party/gflags.url "${srcdir}/gflags"
  git config --local submodule.third_party/googletest.url "${srcdir}/googletest"
  git config --local submodule.third_party/highway.url "${srcdir}/highway"
  git config --local submodule.third_party/lcms.url "${srcdir}/lcms"
  git config --local submodule.third_party/libpng.url "${srcdir}/libpng"
  git config --local submodule.third_party/sjpeg.url "${srcdir}/sjpeg"
  git config --local submodule.third_party/skcms.url "${srcdir}/skcms"
  git config --local submodule.third_party/testdata.url "${srcdir}/testdata"
  git config --local submodule.third_party/zlib.url "${srcdir}/zlib"
  
  git submodule update third_party/brotli
  git submodule update third_party/gflags
  git submodule update third_party/googletest
  git submodule update third_party/highway
  git submodule update third_party/Little-CMS
  git submodule update third_party/libpng
  git submodule update third_party/sjpeg
  git submodule update third_party/skcms
  git submodule update third_party/testdata
  git submodule update third_party/zlib 
}  

build() {
  cd $srcdir/libjxl
  rm -rf build && mkdir build && cd build
  CFLAGS+=" -DHWY_COMPILE_ONLY_SCALAR" \
  CXXFLAGS+=" -DHWY_COMPILE_ONLY_SCALAR" \
  $CMAKE .. -G "Ninja" -DCMAKE_INSTALL_PREFIX=/opt -DCMAKE_BUILD_TYPE=Release \
    -DJPEGXL_ENABLE_PLUGINS=OFF \
    -DBUILD_TESTING=OFF \
    -DJPEGXL_WARNINGS_AS_ERRORS=OFF \
    -DJPEGXL_ENABLE_BENCHMARK=OFF \
    -DJPEGXL_ENABLE_EXAMPLES=OFF \
    -DJPEGXL_ENABLE_MANPAGES=OFF \
    -DJPEGXL_FORCE_SYSTEM_BROTLI=ON \
    -DJPEGXL_FORCE_SYSTEM_HWY=OFF \
    -DJPEGXL_ENABLE_JNI=OFF \
    -DJPEGXL_ENABLE_TCMALLOC=OFF \
    -DJPEGXL_ENABLE_OPENEXR=OFF \ 
  $CMAKE --build .
}

package() {
  cd $srcdir/libjxl/build
  $CMAKE --install . --prefix=$pkgdir/opt
}
